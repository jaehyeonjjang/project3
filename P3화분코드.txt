#include BH1750.h
#include DHT.h
#include SoftwareSerial.h
#include Servo.h
#include Adafruit_NeoPixel.h

 ====================== í•€ ì„¤ì • ======================
#define PIR_PIN 12
#define DOOR_RELAY_PIN 5
#define DOOR_SERVO_PIN 3
#define BIRD_RELAY_PIN 13
#define DHTPIN 7
#define DHTTYPE DHT11
#define FAN_RELAY 9
#define NEO_PIN 2
#define NEO_COUNT 8
#define WATER_TRIG_PIN 4
#define WATER_ECHO_PIN 8
const float TANK_HEIGHT_CM = 13.0;

 ====================== ê°ì²´ ìƒì„± ======================
DHT dht(DHTPIN, DHTTYPE);
SoftwareSerial BT(10, 11);   HC-06
Servo doorServo;
Servo birdServo;
Adafruit_NeoPixel strip(NEO_COUNT, NEO_PIN, NEO_GRB + NEO_KHZ800);
BH1750 lightMeter;

 ====================== ì „ì—­ ë³€ìˆ˜ ======================
String neoState = AUTO;
String fanState = OFF;    ì›¹ ìƒíƒœ ê·¸ëŒ€ë¡œ
String doorState = OFF;   AUTO  ON  OFF  IDLE
String birdState = OFF;

bool door_ch = false;  ë¬¸ ìƒíƒœ ì²´í¬í•˜ê¸°ìš©
bool bird_ch = false;  bird ìƒíƒœ ì²´í¬í•˜ê¸°ìš©

unsigned long lastSensorTime = 0;
unsigned long lastBirdMove = 0;
bool birdDirection = true;

 ----- DOOR ê´€ë ¨ -----
bool doorTriggered = false;     ì¬íŠ¸ë¦¬ê±° ë°©ì§€
bool doorAutoActive = false;    AUTO ë™ì‘ ì¤‘
unsigned long doorAutoStart = 0;
const unsigned long DOOR_ON_DURATION = 700;  ì„œë³´ ë™ì‘ ì‹œê°„(ms)

 ----- BIRD ê´€ë ¨ -----
bool birdAutoActive = false;          AUTO ëª¨ë“œì—ì„œ 3ì´ˆ ON ë™ì‘ ì¤‘
unsigned long birdAutoStart = 0;      AUTO ON ì‹œì‘ ì‹œê°
const unsigned long BIRD_ON_DURATION = 3000;  3ì´ˆ
bool pirTriggered = false;            PIR íŠ¸ë¦¬ê±° ìƒíƒœ


 DOOR ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
unsigned long lastSoilDoorTime = 0;   ë§ˆì§€ë§‰ í† ì–‘ì„¼ì„œì— ì˜í•œ ë¬¸ ì—´ê¸° ì‹œê°„
const unsigned long SOIL_DOOR_INTERVAL = 300000;  5ë¶„ (ms)


 ====================== ì´ˆê¸°í™” ======================
void setup() {
  Serial.begin(9600);
  BT.begin(9600);

  pinMode(PIR_PIN, INPUT);
  pinMode(FAN_RELAY, OUTPUT);
  pinMode(DOOR_RELAY_PIN, OUTPUT);
  pinMode(BIRD_RELAY_PIN, OUTPUT);

  doorServo.attach(DOOR_SERVO_PIN);
  doorServo.write(90);   ì´ˆê¸° ìœ„ì¹˜
  doorServo.detach();


  birdServo.write(0);
  birdServo.detach();

  dht.begin();
  strip.begin();
  strip.show();

  pinMode(WATER_TRIG_PIN, OUTPUT);
  pinMode(WATER_ECHO_PIN, INPUT);

  Wire.begin();
  lightMeter.begin();
  lightMeter.configure(BH1750CONTINUOUS_HIGH_RES_MODE);
}

 ====================== ì„¼ì„œ ì¸¡ì • ======================
float measureWaterLevel() {
  digitalWrite(WATER_TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(WATER_TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(WATER_TRIG_PIN, LOW);

  long duration = pulseIn(WATER_ECHO_PIN, HIGH, 30000);
  if (duration == 0) return -1;
  float distance = duration  0.034  2;
  float level = TANK_HEIGHT_CM - distance;
  return level  0  0  level;
}


void readSensors() {
  if (millis() - lastSensorTime  10000) return;
  lastSensorTime = millis();

  int soil1 = analogRead(A0);
  int soil2 = analogRead(A1);
  int soil3 = analogRead(A2);
  float temp = dht.readTemperature();
  float hum = dht.readHumidity();
  float lux = lightMeter.readLightLevel();
  float waterLevel = measureWaterLevel();

  String waterList = ;
  int threshold = 500;
  if (soil1  threshold) waterList += 1,;
  if (soil2  threshold) waterList += 2,;
  if (soil3  threshold) waterList += 3,;

   ğŸ‘‰ WATERLIST ì²˜ë¦¬
  if (waterList.length()  0) {
    waterList.remove(waterList.length() - 1);   ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
  } else {
    waterList = STOP;   ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ STOP ì „ì†¡
  }

  String data = P1 + String(soil1)
              +  P2 + String(soil2)
              +  P3 + String(soil3)
              +  TEMP + String(temp)
              +  HUM + String(hum)
              +  LUX + String(lux)
              +  WATER + String(int(waterLevel))
              +  NEO + neoState
              +  FAN + fanState
              +  DOOR + doorState
              +  BIRD + birdState
              +  WATERLIST + waterList;

  Serial.println(data);
  BT.println(data);
}


 ====================== ë¸”ë£¨íˆ¬ìŠ¤ ëª…ë ¹ ì²˜ë¦¬ ======================
void commandCheck() {
  String cmd = ;

   1ï¸âƒ£ ë¸”ë£¨íˆ¬ìŠ¤ ì…ë ¥ í™•ì¸
  if (BT.available()) {
    cmd = BT.readStringUntil('n');
    cmd.trim();
  }
   2ï¸âƒ£ ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ì…ë ¥ í™•ì¸
  else if (Serial.available()) {
    cmd = Serial.readStringUntil('n');
    cmd.trim();
  }

  if (cmd == ) return;   ëª…ë ¹ ì—†ìœ¼ë©´ ì¢…ë£Œ
 ===== DOOR ì œì–´ =====
if (cmd == DOOR_ON) doorState = ON;
else if (cmd == DOOR_OFF) doorState = OFF;
else if (cmd == DOOR_AUTO) doorState = AUTO;
else if (cmd == DOOR_CLOSE) {
    if(doorState == AUTO  doorState == IDLE){
        Serial.println(DOOR_CLOSE received); 
        digitalWrite(DOOR_RELAY_PIN, LOW);
        delay(300);
        doorServo.attach(DOOR_SERVO_PIN);
        doorServo.write(110);
        delay(DOOR_ON_DURATION);
        digitalWrite(DOOR_RELAY_PIN, HIGH);
        doorServo.detach();
        doorState = IDLE;
        door_ch = false;
    }
}
else if (cmd == OPEN_DOOR) {   ìƒˆ ëª…ë ¹ ì¶”ê°€
    if(doorState == AUTO  doorState == IDLE) {
        Serial.println(OPEN_DOOR received);
        digitalWrite(DOOR_RELAY_PIN, LOW);
        delay(300);
        doorServo.attach(DOOR_SERVO_PIN);
        doorServo.write(0);   ë¬¸ ì—´ê¸°
        delay(DOOR_ON_DURATION);
        digitalWrite(DOOR_RELAY_PIN, HIGH);
        doorServo.detach();
        doorState = IDLE;
        door_ch = true;
    }
}

   ===== FAN ì œì–´ =====
  else if (cmd == FAN_ON) fanState = ON;
  else if (cmd == FAN_OFF) fanState = OFF;
  else if (cmd == FAN_AUTO) fanState = AUTO;

   ===== BIRD ì œì–´ =====
  else if (cmd == BIRD_ON) birdState = ON;
  else if (cmd == BIRD_OFF) birdState = OFF;
  else if (cmd == BIRD_AUTO) birdState = AUTO;

   ===== NEO ì œì–´ =====
  else if (cmd == NEO_ON) neoState = ON;
  else if (cmd == NEO_OFF) neoState = OFF;
  else if (cmd == NEO_AUTO) neoState = AUTO;
}

 ====================== DOOR ì œì–´ ======================
void doorControl(int soil1, int soil2, int soil3) {
    unsigned long now = millis();

     OPEN_DOOR ëª…ë ¹ìœ¼ë¡œë§Œ ë¬¸ì„ ì—´ë„ë¡ AUTO ëª¨ë“œ ê°ì§€ ì œê±°
    if (doorState == ON) {
        digitalWrite(DOOR_RELAY_PIN, LOW);
        delay(300);
        doorServo.attach(DOOR_SERVO_PIN);
        doorServo.write(110);
        delay(DOOR_ON_DURATION);
        digitalWrite(DOOR_RELAY_PIN, HIGH);
        doorServo.detach();
        doorState = IDLE;
        door_ch = false;
    } 
    else if (doorState == OFF) {
        digitalWrite(DOOR_RELAY_PIN, LOW);
        delay(300);
        doorServo.attach(DOOR_SERVO_PIN);
        doorServo.write(0);
        delay(DOOR_ON_DURATION);
        digitalWrite(DOOR_RELAY_PIN, HIGH);
        doorServo.detach();
        doorState = IDLE;
        door_ch = true;
    }
     AUTO ëª¨ë“œëŠ” ì´ì œ OPEN_DOOR ëª…ë ¹ìœ¼ë¡œë§Œ ì²˜ë¦¬
}


 ====================== NEO ì œì–´ ======================
void neoControl(float lux, float waterLevel) {
  if (neoState == ON) for(int i=0;iNEO_COUNT;i++) strip.setPixelColor(i, strip.Color(0,255,0));
  else if (neoState == OFF) for(int i=0;iNEO_COUNT;i++) strip.setPixelColor(i,0);
  else if (neoState == AUTO) {
    if(waterLevel=0 && waterLevel=3) for(int i=0;iNEO_COUNT;i++) strip.setPixelColor(i, strip.Color(255,0,0));
    else if(lux=30) for(int i=0;iNEO_COUNT;i++) strip.setPixelColor(i, strip.Color(0,255,0));
    else for(int i=0;iNEO_COUNT;i++) strip.setPixelColor(i,0);
  }
  strip.show();
} ====================== BIRD ì œì–´ ======================
void birdControl() {
  unsigned long now = millis();
  bool pirDetected = digitalRead(PIR_PIN);   PIR HIGH ê°ì§€

   ----- AUTO ëª¨ë“œ -----
  if (birdState == AUTO) {
     PIR ì„¼ì„œê°€ ê°ì§€ë˜ì—ˆê³ , ì´ì „ íŠ¸ë¦¬ê±°ê°€ ì—†ê³ , ë¶€ì €ê°€ OFF ìƒíƒœì¼ ë•Œ
    if (pirDetected && !pirTriggered && !birdAutoActive) {
      pirTriggered   = true;              
      birdAutoActive = true;
      birdAutoStart  = now;

      digitalWrite(BIRD_RELAY_PIN, LOW);   ë¶€ì € ON (ì‚~~~)
    }

     ë¶€ì € ON ìƒíƒœ ìœ ì§€
    if (birdAutoActive) {
      if (now - birdAutoStart = BIRD_ON_DURATION) {  3ì´ˆ í›„ OFF
        digitalWrite(BIRD_RELAY_PIN, HIGH);          ë¶€ì € OFF
        birdAutoActive = false;
      }
    }

     PIR ì„¼ì„œ ê°ì§€ í•´ì œ ì‹œ íŠ¸ë¦¬ê±° ì´ˆê¸°í™”
    if (!pirDetected) {
      pirTriggered = false;
    }
  }

   ----- ON ëª¨ë“œ -----
  else if (birdState == ON) {
    digitalWrite(BIRD_RELAY_PIN, LOW);    ê³„ì† ë¶€ì € ON
  }

   ----- OFF ëª¨ë“œ -----
  else {  OFF
    digitalWrite(BIRD_RELAY_PIN, HIGH);   í•­ìƒ ë¶€ì € OFF
    birdAutoActive = false;
  }
}



 ====================== FAN ì œì–´ ======================
void fanControl(float temp) {
  if(fanState==ON) digitalWrite(FAN_RELAY, LOW);
  else if(fanState==OFF) digitalWrite(FAN_RELAY, HIGH);
  else if(fanState==AUTO) digitalWrite(FAN_RELAY, temp=28.0  LOW  HIGH);
}

 ====================== ë©”ì¸ ë£¨í”„ ======================
void loop() {
   1ï¸ ë¨¼ì € ì„¼ì„œ ì½ê³  ê¸°ë³¸ ì „ì†¡
  readSensors();
  commandCheck();   BT + ì‹œë¦¬ì–¼ ëª…ë ¹ ì²˜ë¦¬

   2ï¸ ê°ì¢… ìƒíƒœ ì½ê¸°
  int soil1 = analogRead(A0);
  int soil2 = analogRead(A1);
  int soil3 = analogRead(A2);
  float lux = lightMeter.readLightLevel();
  float waterLevel = measureWaterLevel();
  float temp = dht.readTemperature();

   3ï¸ ì¥ì¹˜ ì œì–´
  fanControl(temp);
  neoControl(lux, waterLevel);
  doorControl(soil1, soil2, soil3);
  birdControl();

   4ï¸ ë¬¸ì´ AUTOë¡œ ì—´ë ¸ë‹¤ë©´, ì—´ë¦¼ ì§í›„ ìƒíƒœ ë‹¤ì‹œ ì „ì†¡
  static bool sentAfterDoor = false;  ë¬¸ ì—´ë¦¼ í›„ ì „ì†¡ ì²´í¬
  if (door_ch && !sentAfterDoor) {    door_ch = true â†’ ë¬¸ ì—´ë¦¼ ì™„ë£Œ
    readSensors();                    í•œ ë²ˆ ë” ì „ì†¡
    sentAfterDoor = true;             ë‹¤ì‹œ ì „ì†¡ ë°©ì§€
  } 
  else if (!door_ch) {                ë¬¸ ë‹«íˆë©´ í”Œë˜ê·¸ ì´ˆê¸°í™”
    sentAfterDoor = false;
  }

  delay(50);
}
